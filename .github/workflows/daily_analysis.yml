name: Daily Stock Analysis

on:
  schedule:
    # í•œêµ­ ì‹œê°„(KST) í‰ì¼ ì˜¤í›„ 4ì‹œ 30ë¶„ ì‹¤í–‰ (UTC 07:30)
    - cron: '30 7 * * 1-5'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ ì¶”ê°€
    inputs:
      force_run:
        description: 'ê±°ë˜ì¼ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ê°•ì œ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)'
        type: boolean
        default: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Restore DB from artifacts
        run: gh run download --name stock-database --dir data/storage || echo "No previous DB found, starting fresh"
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true

      - name: Ensure DB directory exists
        run: mkdir -p data/storage

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libomp-dev # XGBoost êµ¬ë™ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Check trading day
        id: check_trading_day
        env:
          FORCE_RUN: ${{ inputs.force_run || 'false' }}
        run: |
          python3 << 'PYEOF'
          import sys, os
          from datetime import datetime

          force_run = os.environ.get('FORCE_RUN', 'false').lower() == 'true'
          if force_run:
              print('ê°•ì œ ì‹¤í–‰ ëª¨ë“œ: ê±°ë˜ì¼ ì²´í¬ ê±´ë„ˆëœ€')
              is_trading = True
          else:
              try:
                  from pykrx import stock
                  today = datetime.now().strftime('%Y%m%d')
                  # ì‚¼ì„±ì „ì ë‹¹ì¼ OHLCV ì¡°íšŒ â€” ë°ì´í„° ìˆìœ¼ë©´ ê±°ë˜ì¼
                  df = stock.get_market_ohlcv(today, ticker='005930')
                  is_trading = not df.empty
              except Exception as e:
                  print(f'ê±°ë˜ì¼ í™•ì¸ ì‹¤íŒ¨: {e} â†’ ê±°ë˜ì¼ë¡œ ê°„ì£¼í•˜ê³  ì‹¤í–‰', file=sys.stderr)
                  is_trading = True  # ì‹¤íŒ¨ ì‹œ ì•ˆì „í•˜ê²Œ ë¶„ì„ ì‹¤í–‰

          result = 'true' if is_trading else 'false'
          print(f'ì˜¤ëŠ˜({datetime.now().strftime("%Y-%m-%d")}) ê±°ë˜ì¼ ì—¬ë¶€: {result}')
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              fh.write(f'is_trading_day={result}\n')
          PYEOF

      - name: Notify non-trading day
        if: steps.check_trading_day.outputs.is_trading_day == 'false'
        run: |
          DATE=$(TZ=Asia/Seoul date +'%Yë…„ %mì›” %dì¼')
          MSG="ğŸ“… ${DATE}ì€ í•œêµ­ ì¦ì‹œ íœ´ì¥ì¼ì…ë‹ˆë‹¤.%0Aì˜¤ëŠ˜ì€ AI ì¢…ëª© ì¶”ì²œì„ ê±´ë„ˆëœë‹ˆë‹¤."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MSG}"
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Run daily analysis
        if: steps.check_trading_day.outputs.is_trading_day == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DB_PATH: "data/storage/stock_analysis.db"
        run: koreanstocks recommend

      - name: Save DB as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stock-database
          path: data/storage/stock_analysis.db
          retention-days: 90
          overwrite: true

      - name: Commit updated DB to repository
        if: steps.check_trading_day.outputs.is_trading_day == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git add data/storage/stock_analysis.db
          git diff --staged --quiet || git commit -m "chore: daily DB update $(date +'%Y-%m-%d')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
